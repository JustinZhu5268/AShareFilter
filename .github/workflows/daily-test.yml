# AShareFilter 每日回归测试
# 每天自动运行完整测试套件

name: Daily Regression

on:
  schedule:
    # 每天晚上10点运行
    - cron: '0 22 * * *'
  workflow_dispatch:
    # 允许手动触发
    inputs:
      test_type:
        description: 'Test type to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - unit
          - boundary
          - e2e
          - integration

# 环境变量
env:
  USE_MOCK_DATA: 'true'

jobs:
  # 每日测试矩阵
  daily-test:
    runs-on: ubuntu-latest
    name: Daily Test - ${{ matrix.test-type }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - test-type: unit
            python-version: '3.11'
          - test-type: boundary
            python-version: '3.11'
          - test-type: e2e
            python-version: '3.11'
          - test-type: integration
            python-version: '3.11'
          - test-type: performance
            python-version: '3.11'
          - test-type: lint
            python-version: '3.11'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-html

      - name: Run unit tests
        if: matrix.test-type == 'unit'
        env:
          USE_MOCK_DATA: 'true'
        run: |
          pytest tests/test_indicators.py tests/test_chips.py tests/test_cache.py -v --cov=. --cov-report=term

      - name: Run boundary tests
        if: matrix.test-type == 'boundary'
        env:
          USE_MOCK_DATA: 'true'
        run: |
          pytest tests/test_boundary.py -v -m boundary

      - name: Run E2E tests
        if: matrix.test-type == 'e2e'
        env:
          USE_MOCK_DATA: 'true'
        run: |
          pytest tests/test_e2e_enhanced.py tests/test_integration.py -v -m e2e

      - name: Run integration tests
        if: matrix.test-type == 'integration'
        env:
          USE_MOCK_DATA: 'true'
        run: |
          pytest tests/test_integration.py -v -m integration

      - name: Run performance tests
        if: matrix.test-type == 'performance'
        env:
          USE_MOCK_DATA: 'true'
        run: |
          pytest tests/test_performance.py -v -m performance

      - name: Run lint
        if: matrix.test-type == 'lint'
        run: |
          pip install black pylint isort flake8
          black --check . || true
          isort --check-only --diff . || true
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics || true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: daily-test-results-${{ matrix.test-type }}
          path: |
            test_results/
            report.html

  # 完整测试报告
  full-test:
    runs-on: ubuntu-latest
    name: Full Test Report
    needs: [daily-test]
    if: inputs.test_type == 'all' || github.event_name == 'schedule'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-html pytest-xdist

      - name: Run all tests with full report
        env:
          USE_MOCK_DATA: 'true'
        run: |
          pytest tests/ -v --html=daily_report.html --self-contained-html --tb=short -n auto

      - name: Generate test summary
        if: always()
        run: |
          echo "## AShareFilter 每日测试报告" > test_report.md
          echo "**日期**: $(date '+%Y-%m-%d %H:%M:%S')" >> test_report.md
          echo "**触发方式**: ${{ github.event_name }}" >> test_report.md
          echo "" >> test_report.md
          echo "### 测试任务状态" >> test_report.md
          echo "- Unit Tests: ${{ needs.daily-test.result }}" >> test_report.md
          echo "" >> test_report.md
          echo "### 测试统计" >> test_report.md
          echo "查看完整报告了解详细测试结果" >> test_report.md

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: daily-test-results
          path: |
            test_report.md
            daily_report.html

  # 测试失败通知
  notify:
    runs-on: ubuntu-latest
    name: Notify on Failure
    needs: [full-test]
    if: failure()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate failure report
        run: |
          echo "## AShareFilter 每日测试失败报告" > failure_report.md
          echo "**日期**: $(date '+%Y-%m-%d %H:%M:%S')" >> failure_report.md
          echo "**触发方式**: ${{ github.event_name }}" >> failure_report.md
          echo "" >> failure_report.md
          echo "### 失败原因" >> failure_report.md
          echo "测试执行过程中出现错误，请查看 GitHub Actions 日志了解详情。" >> failure_report.md

      - name: Upload failure report
        uses: actions/upload-artifact@v4
        with:
          name: failure-report
          path: failure_report.md

      - name: Create GitHub Issue
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '每日测试失败 - ' + new Date().toISOString().slice(0,10),
              body: '## 测试失败报告\n\n' +
                    '**触发时间**: ' + new Date().toISOString() + '\n' +
                    '**触发方式**: ' + context.eventName + '\n\n' +
                    '请查看 GitHub Actions 日志了解详情。'
            })
